# src: https://github.com/NVIDIA/retinanet-examples/blob/main/Dockerfile.deepstream
FROM nvcr.io/nvidia/pytorch:21.12-py3

ARG DEBIAN_FRONTEND=noninteractive

WORKDIR /opt/
RUN apt-get update && apt-get install -y libssl1.1 libgstreamer1.0-0 gstreamer1.0-tools gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav libgstrtspserver-1.0-0 libjansson4 ffmpeg libjson-glib-1.0 libgles2-mesa libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

# To install Kafka
RUN git clone https://github.com/edenhill/librdkafka.git /librdkafka && \
    cd /librdkafka && ./configure && make -j && make -j install && \
    mkdir -p /opt/nvidia/deepstream/deepstream-6.0/lib && \
    cp /usr/local/lib/librdkafka* /opt/nvidia/deepstream/deepstream-6.0/lib && \
    rm -rf /librdkafka

# To install Deepstream sdk and samples
COPY ./deepstream_sdk_v6.0.0_x86_64.tbz2 /
WORKDIR /   
RUN tar -xvf deepstream_sdk_v6.0.0_x86_64.tbz2
WORKDIR /opt/nvidia/deepstream/deepstream-6.0
RUN ./install.sh
# conofig files + sample apps
RUN chmod u+x ./sources/tools/nvds_logger/setup_nvds_logger.sh

# For decode
WORKDIR /usr/lib/x86_64-linux-gnu
RUN ln -sf libnvcuvid.so.1 libnvcuvid.so

RUN pip install onnxruntime-gpu

WORKDIR /workspace/
